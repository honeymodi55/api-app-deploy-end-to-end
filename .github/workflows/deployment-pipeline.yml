name: API App CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
    #was thinking of adding SonarQube static code analysis here, but will skip for now to keep it simple. Can add in future iterations if needed.
    #adding static code analysis using basic Ruff linter to check for code quality and potential issues before running tests and building the Docker image.

    lint:
        name: Code Linting
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code from current repository
              uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                python-version: '3.11'
                cache: 'pip'
            
            - name: Install dependencies
              run: |
                python -m pip install --upgrade pip
                pip install -r myapp/requirements.txt

            # Ruff is the basic linter for python code, it checks for code quality issues, potential bugs, and enforces coding standards. 
            - name: Install Ruff linter
              run: |
                pip install ruff

            - name: Run Ruff linter
              # showing linting results in GitHub Actions summary ($GITHUB_STEP_SUMMARY) for better visibility of code quality issues directly in the workflow.
              run: |
                echo "### Linting Report ðŸš€" >> $GITHUB_STEP_SUMMARY
                if ruff check myapp/ && ruff format --check myapp/; then
                  echo "âœ… No linting or formatting issues found!" >> $GITHUB_STEP_SUMMARY
                else
                  echo "âŒ Issues found in code style or logic. Check the logs below." >> $GITHUB_STEP_SUMMARY
                  exit 1
                fi

    test:
        name: Unit Testing
        needs: lint
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code from current repository
              uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                python-version: '3.11'
                cache: 'pip'

            - name: Install dependencies
              # Also installing pytest,httpx and pytest-md here to ensure they are available for running tests, even though they are also in requirements.txt. This is to avoid any issues if someone forgets to add them to requirements.txt in the future.
              run: |
                python -m pip install --upgrade pip
                pip install -r myapp/requirements.txt
                pip install pytest httpx pytest-md

            - name: Run tests with pytest
              env:
                PYTHONPATH: ${{ github.workspace }}/myapp #setting env so that pytest can find the application code and tests without import errors
              # running pytest with report generation (md) and appending the report to GitHub Actions summary ($GITHUB_STEP_SUMMARY) for better visibility of test results in the workflow run.
              run: |
                pytest myapp/tests.py --md report.md 
                cat report.md >> $GITHUB_STEP_SUMMARY
        
    build:
        name: Build and Push Docker Image
        needs: test
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code from current repository
              uses: actions/checkout@v4
            
            - name: Configure AWS credentials
              uses: aws-actions/configure-aws-credentials@v4
              with:
                aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
                aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                aws-region: ${{ secrets.AWS_REGION }}
            
            - name: Login to Amazon ECR
              id: login-ecr
              uses: aws-actions/amazon-ecr-login@v2
            
            - name: Build and Push Docker Image to ECR
              env:
                ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
                ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY }}
                IMAGE_TAG: ${{ github.sha }}
              run: |
                docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG -f myapp/Dockerfile .
                docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG

    ### for deploying the app to EC2 instance ###
    deploy-to-ec2-instance:
        name: deploying image to AWS EC2 instance
        needs: build
        runs-on: ubuntu-latest 
        steps:
          - name: Checkout code from current repository
            uses: actions/checkout@v4
            
          - name: Configure AWS credentials
            uses: aws-actions/configure-aws-credentials@v4
            with:
              aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
              aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
              aws-region: ${{ secrets.AWS_REGION }}
            
          - name: Login to Amazon ECR
            id: login-ecr
            uses: aws-actions/amazon-ecr-login@v2

          - name: Deploy to EC2 via SSH
            uses: appleboy/ssh-action@v1.0.3
            with:
              host: ${{ secrets.EC2_HOST }}       # EC2 Public IP or DNS
              username: ec2-user
              key: ${{ secrets.EC2_SSH_KEY }}     # .pem file content
              envs: ECR_REGISTRY,ECR_REPOSITORY,IMAGE_TAG
              script: |
                # 1. Login to ECR on the EC2 instance
                aws ecr get-login-password --region ${{ secrets.AWS_REGION }} | docker login --username AWS --password-stdin ${{ steps.login-ecr.outputs.registry }}
                  
                # 3. Pull the latest image
                docker pull ${{ steps.login-ecr.outputs.registry }}/${{ secrets.ECR_REPOSITORY }}:${{ github.sha }}
                  
                # 4. Run the new container on the same network as your monitoring stack
                docker run -d \
                  --name my-api-app-new-final \
                  --network observability_monitoring \
                  -e OTEL_EXPORTER_OTLP_ENDPOINT="http://otel-collector:4317" \
                  -p 5000:5000 \
                  ${{ steps.login-ecr.outputs.registry }}/${{ secrets.ECR_REPOSITORY }}:${{ github.sha }}
            


    #### for GitOps style deployment ###
    # update-k8s-deployment-manifest:
    #     name: Update Kubernetes Deployment file
    #     needs: build
    #     runs-on: ubuntu-latest
    #     steps:
    #         - name: Checkout code from manifest repository
    #           uses: actions/checkout@v4
    #           id: checkout-manifest
    #           with:
    #             repository: {{ secrets.GITHUBS_USERNAME }}/gitops-api-app
    #             token: {{ secrets.GITOPS_API_APP_ACCESS_TOKEN }}
    #             ref: 'main'
            
    #         - name: Configure AWS credentials
    #           uses: aws-actions/configure-aws-credentials@v4
    #           with:
    #             aws-access-key-id: {{ secrets.AWS_ACCESS_KEY_ID }}
    #             aws-secret-access-key: {{ secrets.AWS_SECRET_ACCESS_KEY }}
    #             aws-region: {{ secrets.AWS_REGION }}
            
    #         - name: Login to Amazon ECR
    #           id: login-ecr
    #           uses: aws-actions/amazon-ecr-login@v2

    #         - name: Update Kubernetes Deployment manifest with new image tag
    #           env:
    #             ECR_REGISTRY: {{ steps.login-ecr.outputs.registry }}
    #             ECR_REPOSITORY: {{ secrets.ECR_REPOSITORY }}
    #             IMAGE_TAG: {{ github.sha }}
    #           run: |
    #             sed -i "s|image: .*|image: $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG|g" kubernetes/deployment.yaml
    #             cat kubernetes/deployment.yaml #printing updated manifest for verification

    #         - name: Commit and Push changes
    #           run: |
    #             git config --global user.email "github-actions@github.com"
    #             git config --global user.name "GitHub Actions"
    #             git add kubernetes/deployment.yaml
    #             git commit -m "Update image to {{ github.sha }} [skip ci]"
    #             git push https://x-access-token:{{ secrets.GITOPS_API_APP_ACCESS_TOKEN }}@github.com/{{ secrets.GITHUBS_USERNAME }}/gitops-api-app.git main
                

    
